# 스레싱
> thrashing

페이지 부재율이 높아 **페이지 교체가 빈번하게 일어나 성능 저하를 초래하는 현상**

다중 프로그래밍 환경에서 메인 메모리에 많은 프로세스가 적재되면 프로세스들이 차지하는 평균 페이지 감소하여 페이지 부재가 자주 발생할 수 있다.

## 스레싱 원인

1. 운영체제는 CPU 이용률을 높이기 위해 프로세스의 수를 늘린다. 
최대 이용률에 도달하면 프로세스의 할당 프레임 수가 충분하지 않으므로 페이지 부재가 빈번하게 일어난다.
2. 운영체제는 프로세서 사용률이 낮으면 다중 프로그래밍을 증가시킨다.
만약 새로운 프로세스가 수행 중인 프로세스의 페이지를 빼앗아서 수행을 시작하게 되면 페이지 부재가 더 많이 발생한다.
- 프로세서가 요구하는 최소한의 수보다 페이지 프레임 수가 적으면 페이지 부재 비율은 증가한다.
- 페이지 부재가 발생하면 프로세스는 페이징 처리장치를 사용하기 위해 중단하고 대기하여 Ready-queue가 비워진다.
- 따라서 페이지 부재가 많이 발생하면 그만큼 중단된 프로세스가 증가하여 프로세스의 효율성은 떨어진다.
- 운영체제는 프로세스 사용률을 높이기 위해, 다중 프로그래밍의 정도를 높여 페이지 부재는 더 늘고 시스템 처리율은 낮아지게 된다.

<p align="center">
  <img src="https://github.com/triflingness/CSnCT-Study/blob/e1186f280aef19252b907d17b5b875aff109b44d/OS/imgs/%EC%8A%A4%EB%A0%88%EC%8B%B1/%EC%8A%A4%EB%A0%88%EC%8B%B1%20%EB%B0%9C%EC%83%9D%EB%A5%A0.png" width="700">
</p>
  

즉, **다중 프로그래밍의 정도가 어느 지점까지 도달하면 프로세서 이용률이 낮아진다.** 

이러한 현상을 **스레싱**이라고 한다.

(해결방법)  

다중 프로그래밍의 정도를 낮춰야 한다.

- **지역 교환 알고리즘** 또는 **우선순위 교환 알고리즘**을 이용하여 제한할 수 있다.

- 지역 교환 알고리즘  
  → 다른 프로세스에서 프레임을 가져오지 못하기 때문에 하나의 스레싱이 발생하더라도 다른 프로세스는 스레싱 현상에 빠지지 않는다.

## 스레싱 예방

지역 모델을 이용한 **워킹 셋(working set model)** 방법이 있다.

- 워킹 셋 모델 : 프로세스가 실제로 얼마큼 프레임을 사용하는 지 검사하여 **지역 모델**을 정의한다.

  - 지역 모델 : 프로세스를 실행할 때 지역 몇 개로 중첩해서 구성하므로 프로그램은 한 지역에서 다른 지역으로 이동하는 과정을 의미한다.

# 지역성, locality

> 실행 중인 프로세스에서 나타나는 특성

프로세스는 한 번 참조한 데이터를 **짧은 시간 안에 다시 참조**하거나

한 번 참조한 데이터의 **위치 근처에 있는 데이터를 짧은 시간 안에 다시 참조**하는 경향이 있다.

이렇게 프로세스는 선호하는 특정 페이지만 집중적으로 참조하는 현상을 **국부성**이라고 한다.

- 스레싱을 방지하려면 각 프로세스에 필요한 프레임을 제공할 수 있어야 한다. 이때 지역성을 이용하여 현재 지역 크기보다 작은 페이지 프레임을 할당하면 페이지 부재의 원인이 될 수 있다.
- 시간 지역성과 공간 지역성으로 분류할 수 있다.

## 시간 지역성

특정 자원들을 상대적으로 짧은 시간 안에 재사용한다.

한 지점에서 특정 메모리 위치를 참조할 때 동일한 위치에서 가까운 미래에 다시 참조할 가능성이 높다.

- 최근 액세스한 항목은 오래 사용하지 않아 다시 액세스할 가능성이 있다.
- 적합한 예) `루프`, `서브 프로그램`, `스택`, `계산이나 합계에 사용되는 변수`

## 공간 지역성

- 메모리의 어떤 위치를 참조하면 그 근처를 이후에도 계속 참조할 가능성이 높다.
- 메모리의 특정 위치를 특정 시간에 참조할 때, 가까운 미래에 가까운 메모리 위치를 참조할 가능성이 높다.
- 적합한 예) `배열 검색(순회)`, `순차적 코드의 실행`, `근처의 관련 변수 선언`

# 워크 셋 모델, Work Set Model

> WSM, Work Set Model

지역성을 기반으로 프로세스가 많이 참조하는 페이지 집합을 메모리 공간에 계속 상주시켜 빈번한 페이지 교체 현상을 줄인다.

- 워킹 셋(Working Set) : 가장 최근의 페이지 참조에 있는 페이지 집합.
- 워킹 셋 윈도우(WSW, Workng Set Window) : 현재시간(t)에서 최근의 일정 시간 단위.  
  → 델타(Δ)를 기호로 사용하며 고정된 변수이다.
- 워킹 셋 사이즈(WSS) : 워킹 셋의 크기.

<p align="center">
  <img src="https://github.com/triflingness/CSnCT-Study/blob/e1186f280aef19252b907d17b5b875aff109b44d/OS/imgs/%EC%8A%A4%EB%A0%88%EC%8B%B1/%EC%9E%91%EC%97%85%20%EC%A7%91%ED%95%A9%20%EB%AA%A8%EB%8D%B8.png" width="700">
</p>

- 워킹 셋 윈도우가 `10`이라고 가정하면  
`t1`에서 워킹 셋은 `{2, 1, 5, 7}`이고  
워킹 셋 사이즈는 `4`이다.
- `t2`에서 워킹 셋은 `{7, 5, 1, 3, 4}`이고  
워킹 셋 사이즈는 `5`이다.
- 워킹 셋 사이즈의 총합을 D라고 하면  
    - D : 각 프로세스의 작업 집합 크기의 총 합
    - m : 메인메모리의 프레임 수

    → `D > m` 이면 스레싱이 발생된다. 

    → 유효한 프레임 수만큼 요구하면 운영체제는 일시 중단 프로세스의 프레임을 다른 프로세스에 할당하여 스레싱을 예방한다.

(정리)

- 워킹 셋 사이즈가 작고 페이지 프레임 수가 적으면, 페이지 부재율이 높아져 스래싱 현상을 일으킬 수 있다.

- 워킹 셋 사이즈가 크고 페이지 프레임 수가 많으면, 현재 사용하지 않는 페이지까지 메모리를 차지하여 메모리 낭비와 다중 프로그래밍 정도를 감소시킨다.

(어려운 점)

- 워킹 셋 윈도우 값의 최적 값이 알려져 있지 않고, 프로세스마다 워킹 셋 윈도우 값의 최적값은 매우 다양하다.

# 페이지 부재 비율, PFF

> PFF, Page Fault Frequency
> 스레싱을 예방하는 직접적인 액세스 방법.

페이지 부재율이 페이지 환경에서 프로세스의 실행을 측정하는 기준이 되어

- 상한값을 넘었을 경우(빈 프레임이 있을 때),
    - 프로세스에 프레임을 더 할당해준다.
- 하한 값보다 낮은 경우(빈 프레임이 없을 때),
    - 프레임을 회수하여 스래싱을 방지하고 페이지 부재율을 측정하여 페이지 부재율이 임계값 안으로 들어오도록 조절한다.

<p align="center">
  <img src="https://github.com/triflingness/CSnCT-Study/blob/e1186f280aef19252b907d17b5b875aff109b44d/OS/imgs/%EC%8A%A4%EB%A0%88%EC%8B%B1/%ED%8E%98%EC%9D%B4%EC%A7%80%20%EB%B6%80%EC%9E%AC%20%EB%B9%84%EC%9C%A8.png" width="700">
</p>

- Working Set Model보다 오버헤드가 적다.
